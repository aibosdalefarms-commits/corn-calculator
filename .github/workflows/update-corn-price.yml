name: Update Crop Prices from GFO

on:
  schedule:
    # Run daily at 12:00 UTC (8:00 AM ET)
    - cron: '0 12 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  update-prices:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch GFO crop prices
        run: |
          # Define crops and their GFO URLs
          declare -A CROP_URLS
          CROP_URLS[corn]="https://gfo.ca/marketing/average-commodity-prices/historical-corn-prices/"
          CROP_URLS[soybean]="https://gfo.ca/marketing/average-commodity-prices/historical-soybean-prices/"
          CROP_URLS[wheat]="https://gfo.ca/marketing/average-commodity-prices/historical-wheat-prices/"

          # Bushel conversion factors (CAD/tonne to CAD/bushel)
          declare -A BUSHEL_FACTORS
          BUSHEL_FACTORS[corn]=39.3679
          BUSHEL_FACTORS[soybean]=36.7437
          BUSHEL_FACTORS[wheat]=36.7437

          for CROP in corn soybean wheat; do
            URL="${CROP_URLS[$CROP]}"
            FACTOR="${BUSHEL_FACTORS[$CROP]}"
            echo "=== Fetching $CROP price from $URL ==="

            # Try fetching the page
            HTTP_CODE=$(curl -s -o /tmp/gfo_${CROP}.html -w "%{http_code}" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
              -H "Accept: text/html" \
              -L "$URL" 2>/dev/null)

            if [ "$HTTP_CODE" != "200" ] || [ ! -s /tmp/gfo_${CROP}.html ]; then
              # Try fallback URL
              FALLBACK="https://gfo.ca/marketing/average-commodity-prices/"
              echo "Primary failed (HTTP $HTTP_CODE), trying fallback: $FALLBACK"
              HTTP_CODE=$(curl -s -o /tmp/gfo_${CROP}.html -w "%{http_code}" \
                -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
                -H "Accept: text/html" \
                -L "$FALLBACK" 2>/dev/null)
            fi

            if [ "$HTTP_CODE" != "200" ] || [ ! -s /tmp/gfo_${CROP}.html ]; then
              echo "Failed to fetch $CROP page (HTTP $HTTP_CODE), skipping"
              continue
            fi

            echo "Fetched $CROP page (HTTP $HTTP_CODE), parsing..."

            # Parse price from HTML
            node -e "
              const fs = require('fs');
              const html = fs.readFileSync('/tmp/gfo_${CROP}.html', 'utf8');
              const factor = ${FACTOR};
              const crop = '${CROP}';

              const months = ['January','February','March','April','May','June',
                             'July','August','September','October','November','December'];

              const rowRegex = /<tr[^>]*>([\s\S]*?)<\/tr>/gi;
              let bestMonth = null;
              let bestPrice = null;
              let match;

              while ((match = rowRegex.exec(html)) !== null) {
                const rowHtml = match[1];
                const cells = [];
                let cellMatch;
                const cellRe = /<td[^>]*>([\s\S]*?)<\/td>/gi;
                while ((cellMatch = cellRe.exec(rowHtml)) !== null) {
                  cells.push(cellMatch[1].replace(/<[^>]*>/g, '').trim());
                }

                if (cells.length >= 3) {
                  const monthText = cells[0];
                  const priceText = cells[2].replace(/[\\\$,]/g, '');
                  const price = parseFloat(priceText);

                  const monthIdx = months.findIndex(m =>
                    monthText.toLowerCase().startsWith(m.toLowerCase().substring(0, 3))
                  );

                  if (monthIdx >= 0 && !isNaN(price) && price > 50 && price < 2000) {
                    bestMonth = monthText;
                    bestPrice = price;
                  }
                }
              }

              if (!bestPrice) {
                console.error('Could not find ' + crop + ' price in GFO page');
                process.exit(1);
              }

              const pricePerBushel = (bestPrice / factor).toFixed(2);

              const data = {
                price: pricePerBushel,
                pricePerTonne: bestPrice.toFixed(2),
                month: bestMonth,
                currency: 'CAD',
                source: 'Grain Farmers of Ontario',
                sourceUrl: '${URL}',
                updatedAt: new Date().toISOString()
              };

              fs.writeFileSync(crop + '-price.json', JSON.stringify(data, null, 2) + '\n');
              console.log('Updated ' + crop + ' price:', JSON.stringify(data));
            " || echo "Warning: Failed to parse $CROP price"
          done

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add corn-price.json soybean-price.json wheat-price.json
          if git diff --staged --quiet; then
            echo "No price changes to commit"
          else
            git commit -m "Update GFO crop prices [automated]"
            git push
          fi
