<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="theme-color" content="#1a1c1e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Corn Cost Calculator - PWA</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1a1c1e;--surface:#232628;--surface-hi:#2c2f33;--border:#3a3d42;
  --text:#e2e4e7;--text-dim:#7a7e85;--accent:#d4a832;
  --omafa:#5b9bd5;--omafa-dim:rgba(91,155,213,0.15);
  --farm:#d4a832;--farm-dim:rgba(212,168,50,0.15);
  --green:#4caf6e;--green-dim:rgba(76,175,110,0.12);
  --red:#e05a4a;--red-dim:rgba(224,90,74,0.12);
  --input-bg:#1e2022;
}
body{font-family:'Barlow',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:28px 16px}
.page{max-width:1040px;margin:0 auto}

/* Auth Screen */
#authScreen{display:flex;align-items:center;justify-content:center;min-height:80vh}
.auth-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:32px;max-width:380px;width:100%}
.auth-card h1{font-family:'Fraunces',Georgia,serif;font-size:26px;color:var(--accent);margin-bottom:8px;text-align:center}
.auth-card .subtitle{font-size:13px;color:var(--text-dim);text-align:center;margin-bottom:28px}
.auth-form{display:flex;flex-direction:column;gap:16px}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group label{font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.8px}
.form-group input{background:var(--input-bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:inherit;font-size:15px;padding:12px;outline:none;transition:border-color .2s}
.form-group input:focus{border-color:var(--accent)}
.auth-btn{background:var(--accent);border:none;color:var(--bg);font-family:inherit;font-size:14px;font-weight:600;padding:12px;border-radius:6px;cursor:pointer;transition:opacity .2s;-webkit-tap-highlight-color:transparent}
.auth-btn:hover{opacity:0.9}
.auth-btn:disabled{opacity:0.5;cursor:not-allowed}
.auth-error{background:var(--red-dim);border:1px solid var(--red);border-radius:6px;color:var(--red);font-size:13px;padding:10px;margin-top:12px;display:none}
.auth-error.show{display:block}
.auth-toggle{text-align:center;margin-top:16px;font-size:13px;color:var(--text-dim)}
.auth-toggle a{color:var(--accent);text-decoration:none;cursor:pointer}

/* Price Update Banner */
.price-banner{background:var(--green-dim);border:1px solid var(--green);border-radius:8px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:10px;font-size:13px}
.price-banner.loading{background:var(--omafa-dim);border-color:var(--omafa)}
.price-banner.loading .pb-icon{color:var(--omafa)}
.price-banner.error{background:var(--red-dim);border-color:var(--red)}
.price-banner.error .pb-icon{color:var(--red)}
.pb-icon{font-size:16px;flex-shrink:0}
.pb-text{flex:1;color:var(--text)}
.pb-text strong{color:var(--green);font-weight:600}
.price-banner.loading .pb-text strong{color:var(--omafa)}
.price-banner.error .pb-text strong{color:var(--red)}

/* User Header */
.user-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:8px}
.user-info{display:flex;align-items:center;gap:10px}
.user-avatar{width:32px;height:32px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;color:var(--bg)}
.user-name{font-size:14px;font-weight:500}
.logout-btn{background:none;border:1px solid var(--border);color:var(--text-dim);font-family:inherit;font-size:12px;padding:6px 12px;border-radius:5px;cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:transparent}
.logout-btn:hover{border-color:var(--red);color:var(--red)}

/* Main App - reuse all existing styles from original calculator */
.header{margin-bottom:20px}
.header h1{font-family:'Fraunces',Georgia,serif;font-size:22px;font-weight:600;color:var(--accent)}
.header p{color:var(--text-dim);font-size:12px;margin-top:4px;line-height:1.5}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:14px}
.panel-title{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1.4px;color:var(--text-dim);margin-bottom:14px}
.settings-row{display:flex;gap:16px;flex-wrap:wrap}
.setting-item{display:flex;flex-direction:column;gap:6px;flex:1;min-width:150px}
.setting-item>label{font-size:10px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.8px}
.setting-input{position:relative}
.setting-input input{width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:inherit;font-size:15px;font-weight:600;padding:8px 28px 8px 12px;outline:none;transition:border-color .2s}
.setting-input input:focus{border-color:var(--accent)}
.setting-input .unit{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:12px;pointer-events:none}
.setting-input input::-webkit-outer-spin-button,.setting-input input::-webkit-inner-spin-button{-webkit-appearance:none}
.setting-input input[type=number]{-moz-appearance:textfield}
.toggle-group{display:flex;border-radius:6px;overflow:hidden;border:1px solid var(--border)}
.toggle-btn{flex:1;background:none;border:none;color:var(--text-dim);font-family:inherit;font-size:12px;font-weight:500;padding:8px 10px;cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:transparent}
.toggle-btn:hover{color:var(--text)}
.toggle-btn.active{background:var(--surface-hi);color:var(--text);font-weight:600}
.toggle-btn.active.t-conv{color:var(--omafa)}
.toggle-btn.active.t-notill{color:var(--green)}
.checkbox-wrap{display:flex;align-items:center;gap:8px;padding:7px 0}
.checkbox-wrap input[type=checkbox]{width:18px;height:18px;accent-color:var(--accent);cursor:pointer;flex-shrink:0}
.checkbox-wrap label{font-size:13px;color:var(--text);cursor:pointer}
.comp-table{width:100%;border-collapse:collapse}
.comp-table thead th{text-align:right;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.7px;color:var(--text-dim);padding:0 0 8px;border-bottom:1px solid var(--border)}
.comp-table thead th:first-child{text-align:left}
.comp-table thead th.col-omafa{color:var(--omafa)}
.comp-table thead th.col-farm{color:var(--farm)}
.comp-table tbody tr{border-bottom:1px solid rgba(58,61,66,.4);transition:background .15s}
.comp-table tbody tr:last-child{border-bottom:none}
.comp-table tbody tr:hover{background:rgba(255,255,255,.02)}
.comp-table td{padding:8px 0;vertical-align:middle}
.cat-cell{display:flex;align-items:center;gap:8px}
.cat-swatch{width:9px;height:9px;border-radius:3px;flex-shrink:0}
.cat-label{font-size:13px;font-weight:500;color:var(--text)}
.val-omafa{text-align:right;font-size:13px;font-weight:500;color:var(--omafa);font-variant-numeric:tabular-nums}
.td-input{text-align:right}
.inp-wrap{position:relative;width:90px;margin-left:auto}
.inp-wrap .sym{position:absolute;left:7px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:10px;pointer-events:none}
.inp-wrap input{width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:5px;color:var(--farm);font-family:inherit;font-size:13px;font-weight:600;padding:5px 5px 5px 16px;text-align:right;outline:none;transition:border-color .2s,box-shadow .2s;font-variant-numeric:tabular-nums}
.inp-wrap input:focus{border-color:var(--farm);box-shadow:0 0 0 2px rgba(212,168,50,.15)}
.inp-wrap input::-webkit-outer-spin-button,.inp-wrap input::-webkit-inner-spin-button{-webkit-appearance:none}
.inp-wrap input[type=number]{-moz-appearance:textfield}
.diff-cell{text-align:right;font-size:11px;font-weight:600;font-variant-numeric:tabular-nums}
.diff-pos{color:var(--green)}.diff-neg{color:var(--red)}.diff-zero{color:var(--text-dim)}
.diff-badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:10px}
.diff-pos .diff-badge{background:var(--green-dim)}
.diff-neg .diff-badge{background:var(--red-dim)}
.diff-zero .diff-badge{background:rgba(122,126,133,.15)}
.mobile-cards{display:none}
.m-card{background:var(--surface-hi);border:1px solid var(--border);border-radius:8px;padding:11px 13px;margin-bottom:7px}
.m-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px}
.m-card-top .cat-label{font-size:14px}
.m-card-row{display:flex;gap:10px;align-items:flex-end}
.m-col{flex:1;display:flex;flex-direction:column;gap:3px}
.m-col-label{font-size:9px;text-transform:uppercase;letter-spacing:0.8px;font-weight:600}
.m-col.omafa-col .m-col-label{color:var(--omafa)}
.m-col.farm-col .m-col-label{color:var(--farm)}
.m-omafa-val{font-size:16px;font-weight:600;color:var(--omafa);font-variant-numeric:tabular-nums;background:var(--input-bg);border-radius:5px;padding:8px 10px;min-height:40px;display:flex;align-items:center}
.m-inp-wrap{position:relative}
.m-inp-wrap .sym{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:11px;pointer-events:none}
.m-inp-wrap input{width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:5px;color:var(--farm);font-family:inherit;font-size:16px;font-weight:600;padding:8px 8px 8px 21px;text-align:right;outline:none;transition:border-color .2s,box-shadow .2s;font-variant-numeric:tabular-nums;min-height:40px}
.m-inp-wrap input:focus{border-color:var(--farm);box-shadow:0 0 0 2px rgba(212,168,50,.15)}
.m-inp-wrap input::-webkit-outer-spin-button,.m-inp-wrap input::-webkit-inner-spin-button{-webkit-appearance:none}
.m-inp-wrap input[type=number]{-moz-appearance:textfield}
.drying-layout{display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap}
.drying-inputs{flex:1;min-width:240px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.dry-item{display:flex;flex-direction:column;gap:4px}
.dry-item>label{font-size:10px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.6px}
.dry-iw{position:relative}
.dry-iw input{width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:inherit;font-size:14px;font-weight:500;padding:7px 22px 7px 10px;outline:none;transition:border-color .2s}
.dry-iw input:focus{border-color:var(--accent)}
.dry-iw .unit{position:absolute;right:8px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:11px;pointer-events:none}
.dry-iw input::-webkit-outer-spin-button,.dry-iw input::-webkit-inner-spin-button{-webkit-appearance:none}
.dry-iw input[type=number]{-moz-appearance:textfield}
.drying-result{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
.dry-stat{text-align:center}
.dry-stat .ds-lbl{font-size:9px;text-transform:uppercase;letter-spacing:0.6px;color:var(--text-dim);font-weight:600;margin-bottom:2px}
.dry-stat .ds-val{font-size:15px;font-weight:600;color:var(--accent);font-variant-numeric:tabular-nums}
.apply-btn{background:rgba(212,168,50,.12);border:1px solid rgba(212,168,50,.3);color:var(--accent);font-family:inherit;font-size:12px;font-weight:600;padding:7px 14px;border-radius:5px;cursor:pointer;transition:all .2s;white-space:nowrap;-webkit-tap-highlight-color:transparent}
.apply-btn:hover,.apply-btn:active{background:rgba(212,168,50,.25)}
.overhead-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px}
.oh-item{background:var(--surface-hi);border:1px solid var(--border);border-radius:7px;padding:10px 12px}
.oh-label{font-size:11px;font-weight:500;color:var(--text);margin-bottom:6px}
.oh-iw{position:relative}
.oh-iw .sym{position:absolute;left:8px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:10px;pointer-events:none}
.oh-iw input{width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:4px;color:var(--farm);font-family:inherit;font-size:14px;font-weight:600;padding:5px 5px 5px 18px;text-align:right;outline:none;font-variant-numeric:tabular-nums}
.oh-iw input:focus{border-color:var(--farm)}
.oh-iw input::-webkit-outer-spin-button,.oh-iw input::-webkit-inner-spin-button{-webkit-appearance:none}
.oh-iw input[type=number]{-moz-appearance:textfield}
.oh-total{text-align:right;font-size:12px;color:var(--text-dim)}
.oh-total strong{color:var(--text);font-weight:600}
.totals-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px}
.total-card{border-radius:8px;padding:14px;text-align:center}
.total-card.op-card{background:var(--omafa-dim);border:1px solid rgba(91,155,213,.25)}
.total-card.oh-card{background:var(--surface-hi);border:1px solid var(--border)}
.total-card.gr-card{background:var(--farm-dim);border:1px solid rgba(212,168,50,.25)}
.total-card .tc-lbl{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);font-weight:600;margin-bottom:4px}
.total-card .tc-val{font-family:'Fraunces',Georgia,serif;font-size:21px;font-weight:700}
.total-card.op-card .tc-val{color:var(--omafa)}
.total-card.oh-card .tc-val{color:var(--text)}
.total-card.gr-card .tc-val{color:var(--farm)}
.total-card .tc-per{font-size:11px;color:var(--text-dim);margin-top:3px}
.diff-summary{text-align:center;padding:9px;background:var(--surface-hi);border-radius:7px;margin-bottom:14px;font-size:13px;color:var(--text-dim)}
.diff-summary strong{font-size:14px;font-weight:700}
.ds-pos{color:var(--green)}.ds-neg{color:var(--red)}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.btn{background:none;border:1px solid var(--border);color:var(--text-dim);font-family:inherit;font-size:11px;font-weight:500;padding:5px 12px;border-radius:5px;cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:transparent}
.btn:hover,.btn:active{border-color:var(--accent);color:var(--accent)}
.btn.copy-btn{border-color:rgba(91,155,213,.3);color:var(--omafa)}
.btn.copy-btn:hover,.btn.copy-btn:active{border-color:var(--omafa);background:var(--omafa-dim)}
.chart-legend{display:flex;justify-content:flex-end;gap:16px;margin-bottom:6px}
.chart-legend-item{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:500;color:var(--text-dim)}
.cl-dot{width:12px;height:12px;border-radius:2px}
.chart-container{position:relative;width:100%;height:320px}
canvas#compChart{display:block;width:100%;height:100%}
.be-layout{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.be-inputs .be-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.be-inputs .be-row>label{width:100px;font-size:12px;font-weight:500;color:var(--text);flex-shrink:0}
.be-iw{position:relative;flex:1}
.be-iw .sym{position:absolute;left:8px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:10px;pointer-events:none}
.be-iw .unit{position:absolute;right:8px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:10px;pointer-events:none}
.be-iw input{width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:inherit;font-size:14px;font-weight:500;padding:7px 28px 7px 20px;outline:none;transition:border-color .2s}
.be-iw input:focus{border-color:var(--accent)}
.be-iw input::-webkit-outer-spin-button,.be-iw input::-webkit-inner-spin-button{-webkit-appearance:none}
.be-iw input[type=number]{-moz-appearance:textfield}
.corn-penalty{font-size:11px;color:var(--red);margin-top:6px;display:none}
.corn-penalty.show{display:block}
.be-results{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.be-card{background:var(--surface-hi);border-radius:7px;padding:10px;text-align:center}
.be-card .bc-lbl{font-size:9px;text-transform:uppercase;letter-spacing:0.7px;color:var(--text-dim);font-weight:600;margin-bottom:3px}
.be-card .bc-val{font-family:'Fraunces',Georgia,serif;font-size:17px;font-weight:700}
.be-card .bc-sub{font-size:9px;color:var(--text-dim);margin-top:2px}
.be-card.wide{grid-column:1/-1}
.bc-omafa{color:var(--omafa)}.bc-farm{color:var(--farm)}
.sens-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:7px;border:1px solid var(--border)}
.sens-table{border-collapse:collapse;min-width:400px;width:100%}
.sens-table th{padding:8px 10px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid var(--border)}
.sens-corner{background:var(--surface-hi);color:var(--text-dim);text-align:left}
.sens-price-hdr{background:var(--surface-hi);color:var(--omafa);text-align:center}
.sens-yield-hdr{background:var(--surface-hi);color:var(--farm);text-align:right;border-right:1px solid var(--border)}
.sens-table td{padding:7px 8px;text-align:center;font-size:12px;font-weight:600;font-variant-numeric:tabular-nums;border-bottom:1px solid rgba(58,61,66,.25)}
.sens-table tr:last-child td,.sens-table tr:last-child th{border-bottom:none}
.sens-note{font-size:10px;color:var(--text-dim);margin-top:8px;line-height:1.4}
.source-note{margin-top:16px;font-size:10px;color:var(--text-dim);line-height:1.6}
.source-note a{color:var(--accent);text-decoration:none}
@media(max-width:640px){
  body{padding:16px 10px}
  .panel{padding:14px}
  .header h1{font-size:19px}
  .settings-row{gap:12px}
  .setting-item{min-width:100%}
  .comp-table{display:none}
  .mobile-cards{display:block}
  .drying-layout{flex-direction:column;gap:10px}
  .drying-inputs{min-width:0;grid-template-columns:1fr 1fr 1fr}
  .drying-result{justify-content:center}
  .overhead-grid{grid-template-columns:1fr;gap:6px}
  .oh-item{display:flex;align-items:center;gap:10px;padding:8px 10px}
  .oh-label{margin-bottom:0;flex:1;font-size:13px}
  .oh-iw{width:100px;flex-shrink:0}
  .totals-row{grid-template-columns:1fr;gap:8px}
  .total-card{display:flex;align-items:center;gap:12px;text-align:left;padding:10px 12px}
  .total-card .tc-lbl{min-width:68px;margin-bottom:0;flex-shrink:0}
  .total-card .tc-val{font-size:18px}
  .total-card .tc-per{margin-top:0;margin-left:auto}
  .chart-container{height:260px}
  .be-layout{grid-template-columns:1fr;gap:14px}
  .be-inputs .be-row>label{width:80px;font-size:13px}
  .be-iw input{font-size:16px;min-height:42px}
  .btn{flex:1;text-align:center;padding:9px 10px;font-size:12px}
  .sens-scroll{margin:0 -14px;border-radius:0;border-left:none;border-right:none}
}
@media(min-width:641px) and (max-width:820px){
  .inp-wrap{width:82px}
  .comp-table thead th{font-size:9px}
  .cat-label{font-size:12px}
  .overhead-grid{grid-template-columns:1fr 1fr}
}

.hidden{display:none !important}
</style>
</head>
<body>

<!-- Auth Screen -->
<div id="authScreen">
  <div class="auth-card">
    <h1>üåΩ Corn Calculator</h1>
    <p class="subtitle">Sign in to save your farm data</p>
    
    <form id="authForm" class="auth-form">
      <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" required autocomplete="username">
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" required autocomplete="current-password">
      </div>
      <button type="submit" class="auth-btn" id="authSubmitBtn">Sign In</button>
    </form>
    
    <div class="auth-error" id="authError"></div>
    
    <div class="auth-toggle">
      <span id="authToggleText">Don't have an account?</span>
      <a id="authToggleLink">Create one</a>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="appScreen" class="hidden">
<div class="page">

<!-- User Header -->
<div class="user-header">
  <div class="user-info">
    <div class="user-avatar" id="userAvatar">U</div>
    <div class="user-name" id="userName">User</div>
  </div>
  <button class="logout-btn" onclick="logout()">Sign Out</button>
</div>

<!-- Price Update Banner -->
<div id="priceBanner" class="price-banner loading">
  <div class="pb-icon">‚è≥</div>
  <div class="pb-text">Fetching latest corn prices from GFO...</div>
</div>

<div class="header">
  <h1>üåΩ Corn Cost Calculator</h1>
  <p>Your Farm vs OMAFA 2025 ‚Äî Southern Ontario ¬∑ All changes save automatically</p>
</div>

<div class="panel">
  <div class="panel-title">Farm Settings</div>
  <div class="settings-row">
    <div class="setting-item">
      <label>Total Corn Acres</label>
      <div class="setting-input">
        <input type="number" id="acreageInput" value="100" min="1" step="1" inputmode="numeric" oninput="updateAll()">
        <span class="unit">ac</span>
      </div>
    </div>
    <div class="setting-item">
      <label>Tillage System</label>
      <div class="toggle-group">
        <button class="toggle-btn active t-conv" id="btnConv" onclick="setTillage('conv')">Conventional</button>
        <button class="toggle-btn" id="btnNoTill" onclick="setTillage('noTill')">No-Till</button>
      </div>
    </div>
    <div class="setting-item">
      <label>Rotation</label>
      <div class="checkbox-wrap">
        <input type="checkbox" id="cornOnCorn" onchange="updateAll()">
        <label for="cornOnCorn">Corn on Corn (8.5% yield penalty)</label>
      </div>
    </div>
  </div>
</div>

<div class="panel">
  <div class="panel-title">Operating Costs ($/acre)</div>
  <table class="comp-table">
    <thead><tr>
      <th style="text-align:left;width:36%">Category</th>
      <th class="col-omafa" style="width:18%">OMAFA</th>
      <th class="col-farm" style="width:24%">Your Farm</th>
      <th style="width:22%">Difference</th>
    </tr></thead>
    <tbody id="tableBody"></tbody>
  </table>
  <div class="mobile-cards" id="mobileCards"></div>
  <div class="btn-row">
    <button class="btn" onclick="resetFarm()">‚Ü∫ Reset to defaults</button>
    <button class="btn copy-btn" onclick="copyOmafa()">‚Üê Copy OMAFA values</button>
  </div>
</div>

<div class="panel">
  <div class="panel-title">Drying Calculator</div>
  <div class="drying-layout">
    <div class="drying-inputs">
      <div class="dry-item">
        <label>Harvest Moisture</label>
        <div class="dry-iw">
          <input type="number" id="harvestMoist" value="25" min="15" max="35" step="1" inputmode="numeric" oninput="calcDrying()">
          <span class="unit">%</span>
        </div>
      </div>
      <div class="dry-item">
        <label>Target Moisture</label>
        <div class="dry-iw">
          <input type="number" id="targetMoist" value="17" min="10" max="25" step="1" inputmode="numeric" oninput="calcDrying()">
          <span class="unit">%</span>
        </div>
      </div>
      <div class="dry-item">
        <label>Cost / Point</label>
        <div class="dry-iw">
          <input type="number" id="dryRate" value="13.51" min="0" step="0.01" inputmode="decimal" oninput="calcDrying()">
          <span class="unit">$/ac</span>
        </div>
      </div>
    </div>
    <div class="drying-result">
      <div class="dry-stat"><div class="ds-lbl">Points</div><div class="ds-val" id="dryPoints">8</div></div>
      <div class="dry-stat"><div class="ds-lbl">Calc. Cost</div><div class="ds-val" id="dryCost">$108.08</div></div>
      <button class="apply-btn" onclick="applyDrying()">Apply to Drying &#8594;</button>
    </div>
  </div>
</div>

<div class="panel">
  <div class="panel-title">Overhead Costs ($/acre)</div>
  <div class="overhead-grid" id="overheadGrid"></div>
  <div class="oh-total">Overhead Total: <strong id="ohTotal">$60.00</strong>/ac</div>
</div>

<div class="totals-row">
  <div class="total-card op-card">
    <div class="tc-lbl">Operating</div>
    <div class="tc-val" id="totalOpWhole">$109,440</div>
    <div class="tc-per" id="totalOpPer">$1,094.40 / acre</div>
  </div>
  <div class="total-card oh-card">
    <div class="tc-lbl">Overhead</div>
    <div class="tc-val" id="totalOhWhole">$6,000</div>
    <div class="tc-per" id="totalOhPer">$60.00 / acre</div>
  </div>
  <div class="total-card gr-card">
    <div class="tc-lbl">Grand Total</div>
    <div class="tc-val" id="totalGrWhole">$115,440</div>
    <div class="tc-per" id="totalGrPer">$1,154.40 / acre</div>
  </div>
</div>
<div class="diff-summary">vs OMAFA: <strong id="diffVal">‚Äî</strong><span id="diffPct"></span></div>

<div class="panel">
  <div class="panel-title">Side-by-Side Comparison</div>
  <div class="chart-legend">
    <div class="chart-legend-item"><div class="cl-dot" style="background:rgba(91,155,213,.7)"></div>OMAFA 2025</div>
    <div class="chart-legend-item"><div class="cl-dot" style="background:rgba(212,168,50,.7)"></div>Your Farm</div>
  </div>
  <div class="chart-container"><canvas id="compChart"></canvas></div>
</div>

<div class="panel">
  <div class="panel-title">Breakeven Calculator</div>
  <div class="be-layout">
    <div class="be-inputs">
      <div class="be-row">
        <label>Corn Price</label>
        <div class="be-iw"><span class="sym">$</span>
          <input type="number" id="priceInput" value="6.06" step="0.01" inputmode="decimal" oninput="updateAll()">
          <span class="unit">$/bu</span>
        </div>
      </div>
      <div class="be-row">
        <label>Your Yield</label>
        <div class="be-iw">
          <input type="number" id="yieldInput" value="185" step="1" inputmode="numeric" oninput="updateAll()">
          <span class="unit">bu/ac</span>
        </div>
      </div>
      <div class="corn-penalty" id="cornPenNote">&#9888; Corn-on-corn: effective yield reduced to <strong id="effYield">169.3</strong> bu/ac</div>
    </div>
    <div class="be-results">
      <div class="be-card"><div class="bc-lbl">OMAFA Breakeven</div><div class="bc-val bc-omafa" id="beOmafa">‚Äî</div><div class="bc-sub">bu/acre needed</div></div>
      <div class="be-card"><div class="bc-lbl">Your Breakeven</div><div class="bc-val bc-farm" id="beFarm">‚Äî</div><div class="bc-sub">bu/acre needed</div></div>
      <div class="be-card"><div class="bc-lbl">Gross Revenue</div><div class="bc-val" id="beRevenue" style="color:var(--text)">‚Äî</div><div class="bc-sub">price x effective yield</div></div>
      <div class="be-card wide"><div class="bc-lbl">Your Net Margin</div><div class="bc-val" id="beMargin">‚Äî</div><div class="bc-sub" id="beStatus">‚Äî</div></div>
    </div>
  </div>
</div>

<div class="panel">
  <div class="panel-title">Sensitivity Analysis ‚Äî Net Margin ($/acre)</div>
  <div class="sens-scroll"><table class="sens-table" id="sensTable"></table></div>
  <div class="sens-note">Net margin at different price and yield combinations using your current grand total. Green = profitable ¬∑ Red = loss ¬∑ Yellow = near breakeven</div>
</div>

<div class="source-note">
  Source: Ontario Ministry of Agriculture, Food &amp; Agribusiness ‚Äî
  <a href="https://www.ontario.ca/files/2025-01/omafa-field-crop-budgets-pub-60-en-2025-01-14.pdf" target="_blank">2025 Field Crop Budgets (Pub. 60)</a> ¬∑
  Land rent: 2024 U of Guelph Farmland Survey ¬∑ No-till values based on OMAFA no-till budget ¬∑ Overhead = depreciation + interest + other fixed costs
</div>
</div><!-- .page -->
</div><!-- #appScreen -->

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
// ‚ïê‚ïê‚ïê FIREBASE CONFIGURATION ‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyDPTBExRvVwmGf4G-qRMEshj6WaoCg-abc",
  authDomain: "corncostcalculator.firebaseapp.com",
  databaseURL: "https://corncostcalculator-default-rtdb.firebaseio.com",
  projectId: "corncostcalculator",
  storageBucket: "corncostcalculator.firebasestorage.app",
  messagingSenderId: "730720739246",
  appId: "1:730720739246:web:6496416453bd3f13c9b23f",
  measurementId: "G-WCNLVVFGJW"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// ‚ïê‚ïê‚ïê AUTH STATE ‚ïê‚ïê‚ïê
let currentUser = null;
let isSignUpMode = false;

// ‚ïê‚ïê‚ïê DATA STRUCTURE ‚ïê‚ïê‚ïê
var CATS = [
  {label:'Land Rent',             conv:337.50, notill:337.50, color:'#8B6914'},
  {label:'Fertilizer (N, P, K)', conv:210.70, notill:210.70, color:'#4caf6e'},
  {label:'Combining & Trucking', conv:111.85, notill:111.85, color:'#e8943a'},
  {label:'Seed (Treated Hybrid)',conv:110.85, notill:110.85, color:'#7c5cbf'},
  {label:'Drying',               conv:108.10, notill:108.10, color:'#5b9bd5', isDrying:true},
  {label:'Tillage',              conv: 78.70, notill: 18.50, color:'#a0825a'},
  {label:'Herbicide',            conv: 30.80, notill: 38.50, color:'#c4d42e'},
  {label:'Planting',             conv: 28.20, notill: 28.20, color:'#f0c040'},
  {label:'Insect. & Fungicides', conv:  4.00, notill:  4.00, color:'#e05a4a'}
];
var OH = [
  {label:'Machinery Depreciation', val:40.00},
  {label:'Interest on Investment', val:13.50},
  {label:'Other Overhead',         val: 6.50}
];
var PRICES = [5.00,5.50,6.00,6.50,7.00];
var YIELDS = [160,170,180,190,200];

var mode = 'conv';
var farmVals = CATS.map(function(c){return c.conv;});
var farmOH   = OH.map(function(o){return o.val;});
var saveTimeout = null;

// ‚ïê‚ïê‚ïê AUTH UI ‚ïê‚ïê‚ïê
function toggleAuthMode() {
  isSignUpMode = !isSignUpMode;
  const btn = document.getElementById('authSubmitBtn');
  const toggle = document.getElementById('authToggleText');
  const link = document.getElementById('authToggleLink');
  
  if (isSignUpMode) {
    btn.textContent = 'Create Account';
    toggle.textContent = 'Already have an account?';
    link.textContent = 'Sign in';
  } else {
    btn.textContent = 'Sign In';
    toggle.textContent = "Don't have an account?";
    link.textContent = 'Create one';
  }
}

document.getElementById('authToggleLink').addEventListener('click', toggleAuthMode);

document.getElementById('authForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const btn = document.getElementById('authSubmitBtn');
  const errorDiv = document.getElementById('authError');
  
  if (!username || !password) {
    showAuthError('Please enter both username and password');
    return;
  }
  
  btn.disabled = true;
  btn.textContent = isSignUpMode ? 'Creating Account...' : 'Signing In...';
  errorDiv.classList.remove('show');
  
  try {
    // Use email format for Firebase (username@corncalc.app)
    const email = username.toLowerCase() + '@corncalc.app';
    
    if (isSignUpMode) {
      await auth.createUserWithEmailAndPassword(email, password);
      await auth.currentUser.updateProfile({ displayName: username });
    } else {
      await auth.signInWithEmailAndPassword(email, password);
    }
  } catch (error) {
    console.error('Auth error:', error);
    showAuthError(getAuthErrorMessage(error));
    btn.disabled = false;
    btn.textContent = isSignUpMode ? 'Create Account' : 'Sign In';
  }
});

function showAuthError(message) {
  const errorDiv = document.getElementById('authError');
  errorDiv.textContent = message;
  errorDiv.classList.add('show');
}

function getAuthErrorMessage(error) {
  switch (error.code) {
    case 'auth/email-already-in-use':
      return 'Username already taken. Please choose another.';
    case 'auth/user-not-found':
      return 'Username not found. Please create an account.';
    case 'auth/wrong-password':
      return 'Incorrect password.';
    case 'auth/weak-password':
      return 'Password should be at least 6 characters.';
    case 'auth/invalid-email':
      return 'Invalid username format.';
    default:
      return 'Authentication failed. Please try again.';
  }
}

function logout() {
  if (confirm('Are you sure you want to sign out?')) {
    auth.signOut();
  }
}

// ‚ïê‚ïê‚ïê AUTH STATE LISTENER ‚ïê‚ïê‚ïê
auth.onAuthStateChanged(function(user) {
  if (user) {
    currentUser = user;
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('appScreen').classList.remove('hidden');
    
    const username = user.displayName || user.email.split('@')[0];
    document.getElementById('userName').textContent = username;
    document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
    
    loadUserData();
    fetchCornPrice();
  } else {
    currentUser = null;
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('appScreen').classList.add('hidden');
  }
});

// ‚ïê‚ïê‚ïê DATA PERSISTENCE ‚ïê‚ïê‚ïê
function saveUserData() {
  if (!currentUser) return;
  clearTimeout(saveTimeout);
  
  saveTimeout = setTimeout(function() {
    const data = {
      acreage: parseFloat(document.getElementById('acreageInput').value) || 100,
      mode: mode,
      cornOnCorn: document.getElementById('cornOnCorn').checked,
      farmVals: farmVals,
      farmOH: farmOH,
      harvestMoist: parseFloat(document.getElementById('harvestMoist').value) || 25,
      targetMoist: parseFloat(document.getElementById('targetMoist').value) || 17,
      dryRate: parseFloat(document.getElementById('dryRate').value) || 13.51,
      price: parseFloat(document.getElementById('priceInput').value) || 6.06,
      yield: parseFloat(document.getElementById('yieldInput').value) || 185,
      lastUpdated: Date.now()
    };
    
    db.ref('users/' + currentUser.uid).set(data).catch(function(error) {
      console.error('Save error:', error);
    });
  }, 1000);
}

function loadUserData() {
  if (!currentUser) return;
  
  db.ref('users/' + currentUser.uid).once('value').then(function(snapshot) {
    const data = snapshot.val();
    if (!data) {
      init();
      return;
    }
    
    document.getElementById('acreageInput').value = data.acreage || 100;
    mode = data.mode || 'conv';
    document.getElementById('cornOnCorn').checked = data.cornOnCorn || false;
    
    if (data.farmVals && data.farmVals.length === CATS.length) {
      farmVals = data.farmVals;
    }
    if (data.farmOH && data.farmOH.length === OH.length) {
      farmOH = data.farmOH;
    }
    
    document.getElementById('harvestMoist').value = data.harvestMoist || 25;
    document.getElementById('targetMoist').value = data.targetMoist || 17;
    document.getElementById('dryRate').value = data.dryRate || 13.51;
    document.getElementById('priceInput').value = data.price || 6.06;
    document.getElementById('yieldInput').value = data.yield || 185;
    
    setTillage(mode);
    init();
  }).catch(function(error) {
    console.error('Load error:', error);
    init();
  });
}

// ‚ïê‚ïê‚ïê PRICE FETCHING ‚ïê‚ïê‚ïê
async function fetchCornPrice() {
  const banner = document.getElementById('priceBanner');
  banner.className = 'price-banner loading';
  banner.innerHTML = '<div class="pb-icon">‚è≥</div><div class="pb-text">Fetching latest corn prices from GFO... <button onclick="fetchCornPrice()" style="margin-left:8px;padding:2px 8px;border:1px solid var(--omafa);background:none;color:var(--omafa);border-radius:3px;font-size:11px;cursor:pointer;">Retry</button></div>';
  
  // Try multiple CORS proxies in order
  const proxies = [
    'https://corsproxy.io/?',
    'https://api.codetabs.com/v1/proxy?quest=',
    'https://api.allorigins.win/raw?url='
  ];
  
  const targetUrl = 'https://gfo.ca/average-commodity-prices/';
  
  for (let i = 0; i < proxies.length; i++) {
    try {
      const proxyUrl = proxies[i] + encodeURIComponent(targetUrl);
      const response = await fetch(proxyUrl, { 
        method: 'GET',
        headers: { 'Accept': 'text/html' }
      });
      
      if (!response.ok) throw new Error('HTTP ' + response.status);
      
      const html = await response.text();
      const result = parseCornPrice(html);
      
      if (result.success) {
        banner.className = 'price-banner';
        banner.innerHTML = '<div class="pb-icon">‚úì</div><div class="pb-text">Price updated: <strong>$' + result.price + '/bu</strong> (' + result.month + ' GFO average) <button onclick="fetchCornPrice()" style="margin-left:8px;padding:2px 8px;border:1px solid var(--green);background:none;color:var(--green);border-radius:3px;font-size:11px;cursor:pointer;">Refresh</button></div>';
        
        // Update the price input
        document.getElementById('priceInput').value = result.price;
        updateAll();
        return; // Success, exit
      }
    } catch (error) {
      console.log('Proxy ' + i + ' failed:', error);
      // Try next proxy
      continue;
    }
  }
  
  // All proxies failed
  showPriceError();
}

function parseCornPrice(html) {
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // Look for heading containing "Corn"
    const headings = doc.querySelectorAll('h2, h3');
    let cornSection = null;
    
    for (let heading of headings) {
      if (heading.textContent.trim() === 'Corn') {
        cornSection = heading;
        break;
      }
    }
    
    if (!cornSection) {
      throw new Error('Corn section not found');
    }
    
    // Get the next table after the Corn heading
    let currentElement = cornSection.nextElementSibling;
    while (currentElement) {
      if (currentElement.tagName === 'TABLE') {
        const rows = currentElement.querySelectorAll('tbody tr');
        if (rows.length > 0) {
          // Get the last row (most recent month)
          const lastRow = rows[rows.length - 1];
          const cells = lastRow.querySelectorAll('td');
          
          if (cells.length >= 3) {
            const month = cells[0].textContent.trim();
            const priceText = cells[2].textContent.trim().replace('$', '').replace(',', '');
            const pricePerTonne = parseFloat(priceText);
            
            if (!isNaN(pricePerTonne) && pricePerTonne > 0) {
              // Convert $/tonne to $/bushel (1 tonne corn = 39.37 bushels)
              const pricePerBushel = (pricePerTonne / 39.37).toFixed(2);
              
              return {
                success: true,
                price: pricePerBushel,
                month: month,
                source: 'GFO'
              };
            }
          }
        }
        break;
      }
      currentElement = currentElement.nextElementSibling;
    }
    
    throw new Error('Could not parse corn price from table');
  } catch (error) {
    console.error('Parse error:', error);
    return { success: false };
  }
}

function showPriceError() {
  const banner = document.getElementById('priceBanner');
  banner.className = 'price-banner error';
  banner.innerHTML = '<div class="pb-icon">‚ö†</div><div class="pb-text">Could not fetch GFO prices. Using current value ($' + 
    (parseFloat(document.getElementById('priceInput').value) || 6.06).toFixed(2) + 
    '/bu). <button onclick="fetchCornPrice()" style="margin-left:8px;padding:2px 8px;border:1px solid var(--red);background:none;color:var(--red);border-radius:3px;font-size:11px;cursor:pointer;">Retry</button></div>';
}

// ‚ïê‚ïê‚ïê CALCULATOR LOGIC (same as original) ‚ïê‚ïê‚ïê
function omafa(i){return mode==='conv'?CATS[i].conv:CATS[i].notill;}
function omafaOpTot(){var t=0;for(var i=0;i<CATS.length;i++)t+=omafa(i);return t;}
function omafaOhTot(){var t=0;for(var i=0;i<OH.length;i++)t+=OH[i].val;return t;}
function farmOpTot(){var t=0;for(var i=0;i<farmVals.length;i++)t+=farmVals[i];return t;}
function farmOhTot(){var t=0;for(var i=0;i<farmOH.length;i++)t+=farmOH[i];return t;}
function farmGrand(){return farmOpTot()+farmOhTot();}
function omafaGrand(){return omafaOpTot()+omafaOhTot();}
function acres(){return parseFloat(document.getElementById('acreageInput').value)||1;}
function hasCOC(){return document.getElementById('cornOnCorn').checked;}
function f2(n){return n.toFixed(2);}
function fmtComma(n){
  var r=Math.round(n),neg=r<0;r=Math.abs(r);
  var s=r.toString(),out='';
  for(var i=s.length-1,c=0;i>=0;i--,c++){
    if(c>0&&c%3===0)out=','+out;
    out=s[i]+out;
  }
  return (neg?'-':'')+'$'+out;
}

function buildTable(){
  var tb=document.getElementById('tableBody');tb.innerHTML='';
  for(var i=0;i<CATS.length;i++){
    var c=CATS[i],tr=document.createElement('tr');
    tr.innerHTML='<td><div class="cat-cell"><div class="cat-swatch" style="background:'+c.color+'"></div><span class="cat-label">'+c.label+'</span></div></td>'+
      '<td class="val-omafa" id="om_'+i+'">$'+f2(omafa(i))+'</td>'+
      '<td class="td-input"><div class="inp-wrap"><span class="sym">$</span>'+
        '<input type="number" id="f_'+i+'" value="'+f2(farmVals[i])+'" step="0.01" inputmode="decimal" oninput="upFarm('+i+',this.value)">'+
      '</div></td>'+
      '<td class="diff-cell" id="d_'+i+'"></td>';
    tb.appendChild(tr);
  }
}

function buildCards(){
  var el=document.getElementById('mobileCards');el.innerHTML='';
  for(var i=0;i<CATS.length;i++){
    var c=CATS[i],card=document.createElement('div');card.className='m-card';
    card.innerHTML='<div class="m-card-top"><div class="cat-cell"><div class="cat-swatch" style="background:'+c.color+'"></div><span class="cat-label">'+c.label+'</span></div><div class="diff-cell" id="md_'+i+'"></div></div>'+
      '<div class="m-card-row">'+
        '<div class="m-col omafa-col"><div class="m-col-label">OMAFA</div><div class="m-omafa-val" id="mom_'+i+'">$'+f2(omafa(i))+'</div></div>'+
        '<div class="m-col farm-col"><div class="m-col-label">Your Farm</div><div class="m-inp-wrap"><span class="sym">$</span>'+
          '<input type="number" id="mf_'+i+'" value="'+f2(farmVals[i])+'" step="0.01" inputmode="decimal" oninput="upFarm('+i+',this.value)">'+
        '</div></div></div>';
    el.appendChild(card);
  }
}

function buildOH(){
  var g=document.getElementById('overheadGrid');g.innerHTML='';
  for(var i=0;i<OH.length;i++){
    var item=document.createElement('div');item.className='oh-item';
    item.innerHTML='<div class="oh-label">'+OH[i].label+'</div>'+
      '<div class="oh-iw"><span class="sym">$</span>'+
        '<input type="number" id="oh_'+i+'" value="'+f2(farmOH[i])+'" step="0.01" inputmode="decimal" oninput="upOH('+i+',this.value)">'+
      '</div>';
    g.appendChild(item);
  }
}

function upFarm(i,v){
  farmVals[i]=parseFloat(v)||0;
  var d=document.getElementById('f_'+i),m=document.getElementById('mf_'+i);
  if(d&&document.activeElement!==d)d.value=v;
  if(m&&document.activeElement!==m)m.value=v;
  renderDiff(i);updateTotals();drawChart();updateBE();updateSens();
  saveUserData();
}
function upOH(i,v){
  farmOH[i]=parseFloat(v)||0;
  updateTotals();updateBE();updateSens();
  saveUserData();
}
function renderDiff(i){
  var diff=farmVals[i]-omafa(i),cls,sign;
  if(Math.abs(diff)<0.005){cls='diff-zero';sign='&#8212;';}
  else if(diff<0){cls='diff-pos';sign='-$'+Math.abs(diff).toFixed(2);}
  else{cls='diff-neg';sign='+$'+diff.toFixed(2);}
  var html='<span class="diff-badge">'+sign+'</span>';
  var d=document.getElementById('d_'+i);if(d){d.className='diff-cell '+cls;d.innerHTML=html;}
  var m=document.getElementById('md_'+i);if(m){m.className='diff-cell '+cls;m.innerHTML=html;}
}
function updateOmafaCol(){
  for(var i=0;i<CATS.length;i++){
    var d=document.getElementById('om_'+i);if(d)d.textContent='$'+f2(omafa(i));
    var m=document.getElementById('mom_'+i);if(m)m.textContent='$'+f2(omafa(i));
    renderDiff(i);
  }
}
function setTillage(m){
  mode=m;
  document.getElementById('btnConv').className='toggle-btn'+(m==='conv'?' active t-conv':'');
  document.getElementById('btnNoTill').className='toggle-btn'+(m==='noTill'?' active t-notill':'');
  updateOmafaCol();updateTotals();drawChart();updateBE();updateSens();
  saveUserData();
}
function resetFarm(){
  for(var i=0;i<CATS.length;i++){
    farmVals[i]=omafa(i);
    var d=document.getElementById('f_'+i);if(d)d.value=f2(farmVals[i]);
    var m=document.getElementById('mf_'+i);if(m)m.value=f2(farmVals[i]);
    renderDiff(i);
  }
  for(var i=0;i<OH.length;i++){
    farmOH[i]=OH[i].val;
    var e=document.getElementById('oh_'+i);if(e)e.value=f2(farmOH[i]);
  }
  updateTotals();drawChart();updateBE();updateSens();
  saveUserData();
}
function copyOmafa(){resetFarm();}

function calcDrying(){
  var h=parseFloat(document.getElementById('harvestMoist').value)||25;
  var t=parseFloat(document.getElementById('targetMoist').value)||17;
  var r=parseFloat(document.getElementById('dryRate').value)||13.51;
  var pts=Math.max(0,h-t);
  document.getElementById('dryPoints').textContent=pts;
  document.getElementById('dryCost').textContent='$'+f2(pts*r);
}
function applyDrying(){
  var h=parseFloat(document.getElementById('harvestMoist').value)||25;
  var t=parseFloat(document.getElementById('targetMoist').value)||17;
  var r=parseFloat(document.getElementById('dryRate').value)||13.51;
  var cost=Math.max(0,h-t)*r;
  for(var i=0;i<CATS.length;i++){if(CATS[i].isDrying){upFarm(i,f2(cost));break;}}
}

function updateTotals(){
  var ac=acres();
  var opT=farmOpTot(), ohT=farmOhTot(), grT=opT+ohT;
  document.getElementById('totalOpWhole').textContent=fmtComma(opT*ac);
  document.getElementById('totalOpPer').textContent='$'+f2(opT)+' / acre';
  document.getElementById('totalOhWhole').textContent=fmtComma(ohT*ac);
  document.getElementById('totalOhPer').textContent='$'+f2(ohT)+' / acre';
  document.getElementById('totalGrWhole').textContent=fmtComma(grT*ac);
  document.getElementById('totalGrPer').textContent='$'+f2(grT)+' / acre';
  document.getElementById('ohTotal').textContent='$'+f2(ohT);

  var omG=omafaGrand(), diff=grT-omG;
  var dEl=document.getElementById('diffVal'),pEl=document.getElementById('diffPct');
  if(Math.abs(diff)<0.005){dEl.textContent='$0.00';dEl.className='';pEl.textContent=' ‚Äî on budget';}
  else if(diff<0){dEl.textContent='-$'+Math.abs(diff).toFixed(2);dEl.className='ds-pos';pEl.textContent=' ('+(Math.abs(diff)/omG*100).toFixed(1)+'% under OMAFA)';}
  else{dEl.textContent='+$'+diff.toFixed(2);dEl.className='ds-neg';pEl.textContent=' ('+(diff/omG*100).toFixed(1)+'% over OMAFA)';}
}

function drawChart(){
  var canvas=document.getElementById('compChart');
  if(!canvas||!canvas.getContext)return;
  var ctx=canvas.getContext('2d');
  var rect=canvas.getBoundingClientRect();
  if(rect.width<10||rect.height<10)return;
  var dpr=window.devicePixelRatio||1;
  canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
  ctx.scale(dpr,dpr);
  var w=rect.width,h=rect.height;
  ctx.clearRect(0,0,w,h);

  var isMob=w<500;
  var pL=isMob?105:145, pR=16, pT=8, pB=26;
  var cW=w-pL-pR, cH=h-pT-pB;
  var n=CATS.length, gH=cH/n, bH=Math.min(gH*0.36,13), gap=2;

  var mx=0;
  for(var i=0;i<n;i++){var o=omafa(i);if(o>mx)mx=o;if(farmVals[i]>mx)mx=farmVals[i];}
  mx*=1.12;
  var sc=cW/mx;

  var step=100;
  ctx.strokeStyle='rgba(58,61,66,0.5)';ctx.lineWidth=1;
  ctx.fillStyle='#7a7e85';
  ctx.font=(isMob?'9':'10')+'px Barlow,-apple-system,sans-serif';
  ctx.textAlign='center';ctx.textBaseline='top';
  for(var t=0;t<=mx;t+=step){
    var x=pL+t*sc;if(x>w-pR+1)break;
    ctx.beginPath();ctx.moveTo(x,pT);ctx.lineTo(x,h-pB);ctx.stroke();
    ctx.fillText('$'+t,x,h-pB+4);
  }

  for(var i=0;i<n;i++){
    var y=pT+i*gH, oV=omafa(i), fV=farmVals[i];
    var oW=oV*sc, fW=fV*sc;
    var y1=y+gH/2-gap-bH, y2=y+gH/2+gap;

    ctx.fillStyle='rgba(91,155,213,0.55)';ctx.strokeStyle='rgba(91,155,213,0.85)';ctx.lineWidth=1;
    rRect(ctx,pL,y1,Math.max(oW,1),bH,2);ctx.fill();ctx.stroke();

    ctx.fillStyle='rgba(212,168,50,0.55)';ctx.strokeStyle='rgba(212,168,50,0.85)';
    rRect(ctx,pL,y2,Math.max(fW,1),bH,2);ctx.fill();ctx.stroke();

    ctx.fillStyle='#e2e4e7';
    ctx.font=(isMob?'500 10px':'500 11px')+' Barlow,-apple-system,sans-serif';
    ctx.textAlign='right';ctx.textBaseline='middle';
    var lbl=CATS[i].label;
    if(isMob&&lbl.length>13)lbl=lbl.substring(0,12)+'\u2026';
    ctx.fillText(lbl,pL-8,y+gH/2);
  }
}
function rRect(ctx,x,y,w,h,r){
  if(w<2*r)r=w/2;if(h<2*r)r=h/2;
  ctx.beginPath();
  ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

function updateBE(){
  var price=parseFloat(document.getElementById('priceInput').value)||0;
  var yld=parseFloat(document.getElementById('yieldInput').value)||0;
  var coc=hasCOC();
  var effYld=coc?yld*0.915:yld;

  var pn=document.getElementById('cornPenNote');
  if(coc){pn.className='corn-penalty show';document.getElementById('effYield').textContent=effYld.toFixed(1);}
  else{pn.className='corn-penalty';}

  var oG=omafaGrand(), fG=farmGrand();
  var beO=price>0?oG/price:Infinity;
  var beF=price>0?fG/price:Infinity;
  document.getElementById('beOmafa').textContent=isFinite(beO)?beO.toFixed(1)+' bu':'‚Äî';
  document.getElementById('beFarm').textContent=isFinite(beF)?beF.toFixed(1)+' bu':'‚Äî';

  var rev=price*effYld, margin=rev-fG;
  document.getElementById('beRevenue').textContent='$'+f2(rev);

  var mEl=document.getElementById('beMargin'),mSub=document.getElementById('beStatus');
  mEl.textContent=(margin>=0?'+':'')+' $'+f2(margin);
  if(margin>=0){
    mEl.style.color='var(--green)';
    mSub.textContent='surplus ‚Äî '+(margin/fG*100).toFixed(1)+'% above costs';mSub.style.color='var(--green)';
  }else{
    mEl.style.color='var(--red)';
    var need=isFinite(beF)?beF-effYld:0;
    mSub.textContent='shortfall ‚Äî need '+need.toFixed(1)+' more bu/ac';mSub.style.color='var(--red)';
  }
}

function updateSens(){
  var gT=farmGrand();
  var tbl=document.getElementById('sensTable');
  var html='<tr><th class="sens-corner">Yield \\ Price</th>';
  for(var p=0;p<PRICES.length;p++)html+='<th class="sens-price-hdr">$'+PRICES[p].toFixed(2)+'/bu</th>';
  html+='</tr>';
  for(var y=0;y<YIELDS.length;y++){
    html+='<tr><th class="sens-yield-hdr">'+YIELDS[y]+' bu</th>';
    for(var p=0;p<PRICES.length;p++){
      var margin=(PRICES[p]*YIELDS[y])-gT;
      var bg=sensColor(margin), tc=sensText(margin);
      var disp=(margin>=0?'+':'')+Math.round(margin);
      html+='<td style="background:'+bg+';color:'+tc+'">$'+disp+'</td>';
    }
    html+='</tr>';
  }
  tbl.innerHTML=html;
}
function sensColor(m){
  var r=(m+250)/500;r=Math.max(0,Math.min(1,r));
  var hue=Math.round(10+r*130);
  var light=r<0.3?40:(r>0.7?36:44);
  return 'hsl('+hue+',65%,'+light+'%)';
}
function sensText(m){
  var r=(m+250)/500;r=Math.max(0,Math.min(1,r));
  return(r>=0.3&&r<=0.7)?'#1a1c1e':'#f0f0f0';
}

function updateAll(){
  updateTotals();drawChart();updateBE();updateSens();
  saveUserData();
}

var initDone=false;
function init(){
  if(initDone)return;
  initDone=true;
  buildTable();buildCards();buildOH();
  for(var i=0;i<CATS.length;i++)renderDiff(i);
  calcDrying();updateAll();
  setTimeout(function(){drawChart();},80);
}

if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded',function(){
    if(currentUser)init();
  });
}
window.addEventListener('load',function(){
  if(currentUser){
    init();
    setTimeout(function(){drawChart();},50);
  }
});
window.addEventListener('resize',function(){if(currentUser)drawChart();});

// Service worker disabled for instant updates
// App now requires internet connection but updates instantly
if('serviceWorker' in navigator){
  // Unregister any existing service workers
  navigator.serviceWorker.getRegistrations().then(function(registrations) {
    for(let registration of registrations) {
      registration.unregister();
    }
  });
}

</script>
</body>
</html>
